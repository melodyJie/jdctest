$(function(){var a={dataObj:null,teamData:null,userDataChange:!1,defaultWorkday:5,msFormat:864e5,weekDayTxt:["周日","周一","周二","周三","周四","周五","周六","周日"],editArea:$("#J_editArea"),init:function(){var a=this;a.initData(),a.bindHandler()},initData:function(){var a=this;a.initDateTime(),a.getjsonData()},bindHandler:function(){var a=this;$("#J_startTime").on("changeDate",function(b){a.rendWorkdayList(),$("#J_endTime").datetimepicker("setStartDate",$("#J_startTime").val())}),$("#J_endTime").on("changeDate",function(b){a.rendWorkdayList()}),$("#J_teamType").on("change",function(b){a.renderTeamUser()}),$("#J_editUsers").on("click",function(a){$("#J_teamUsers").toggleClass("hide")}),$("#J_saveUsers").on("click",function(b){var c=JSON.stringify(a.dataObj);$.ajax({url:"data.php",data:{type:"save",datas:c},type:"POST",success:function(a){"ok"==a&&$("#J_saveUsers").addClass("hide")}})}),$("#J_teamUsers").on("click",".team-user-item",function(b){var c=$(this),d=c.data("data"),e=c.index();a.editUserItem(d,e)}),$("#J_teamUsers").on("click",".team-user-item .btn-del",function(b){b.stopPropagation();var c=$(this).parent(),d=c.index();c.remove(),a.editArea.find(".user-item").eq(d).remove(),a.teamData.splice(d,1),a.userDataChange=!0,$("#J_saveUsers").removeClass("hide")}),$("#J_userAdd").on("click",function(a){var b=$("#J_userPopup");b.find("input").val(""),b.attr("data-type","new"),b.find(".modal-title").text("新增成员")}),$("#J_userPopup .btn-save").on("click",function(b){for(var c,d=$("#J_userPopup"),e=d.attr("data-type"),f=d.attr("data-index"),g=d.find(".form-control"),h="edit"==e?a.teamData[f]:{},i=0,j=g.length;j>i;i++)c=$(g[i]),h[c.attr("name")]=c.val();"edit"==e?a.editTeamUserItem(h,f):"new"==e&&(a.renderTeamUserItem(h),a.teamData.push(h)),d.modal("hide"),a.userDataChange=!0,$("#J_saveUsers").removeClass("hide")}),a.editArea.on("click",".schedule-btn-add",function(a){var b=$("#J_tpl .schedule-item").clone();b.insertBefore($(this))}),a.editArea.on("click",".schedule-btn-del",function(a){var b=$(this).parents(".schedule-item");b.remove()}),$("#J_generator").on("click",function(b){a.renderTable()}),$("#J_result .btn").on("click",function(b){a.selectTable()})},initDateTime:function(){var a=this,b={language:"zh-CN",format:"yyyy-mm-dd",weekStart:1,autoclose:1,todayHighlight:1,minView:3,forceParse:0,startDate:new Date},c=1,d=a.getMondayDate(new Date,c);$("#J_startTime").val(d),$("#J_startTime").datetimepicker(b),d=new Date(d).getTime()+(a.defaultWorkday-1)*a.msFormat,d=new Date(d),d=a.getFormatDate(d,c),$("#J_endTime").val(d),$("#J_endTime").datetimepicker(b),$("#J_endTime").datetimepicker("setStartDate",$("#J_startTime").val()),a.rendWorkdayList()},getMondayDate:function(a,b){var c=this,d=a.getDay();if(0!=d){var e=a.getTime()+(7-d+1)*c.msFormat;a=new Date(e)}var f=c.getFormatDate(a,b);return f},getFormatDate:function(a,b){var c=this,d=a.getFullYear(),e=a.getMonth()+1;e=9>e?"0"+e:e;var f=a.getDate();f=9>f?"0"+f:f;var g=c.weekDayTxt[a.getDay()];switch(b){case 1:str=d+"-"+e+"-"+f;break;case 2:str=g+"("+(a.getMonth()+1)+"月"+a.getDate()+"日)";break;case 3:str=e+"."+f}return str},rendWorkdayList:function(){var a=this,b=$("#J_startTime").val();b=new Date(b).getTime();var c=$("#J_endTime").val();c=new Date(c).getTime();var d,e,f,g=(c-b)/a.msFormat,h=$("#J_tpl .days-item");$("#J_weekDays").html("");for(var i=0;g>=i;i++)d=b+i*a.msFormat,d=new Date(d),e=a.getFormatDate(d,2),f=h.clone(),f.find("input").data("date",d),f.find(".txt").text(e),$("#J_weekDays").append(f)},getjsonData:function(){var a=this;$.ajax({url:"data.php",data:{type:"get"},dataType:"jsonp",success:function(b){a.dataObj=b,a.renderTeamUser(),a.editArea.find(".form-group").removeClass("hide")}})},renderTeamUser:function(){var a=this,b=$("#J_teamType").val();a.editArea.find(".user-item").remove(),$("#J_teamUsers .team-user-item").remove();var c=a.dataObj[b];a.teamData=c;for(var d=($("#J_tpl .user-item"),0),e=c.length;e>d;d++)item=c[d],a.renderTeamUserItem(item)},renderTeamUserItem:function(a){var b=this,c=$("#J_tpl .user-item").clone();c.find(".control-label").text(a.name),c.insertBefore(b.editArea.find(".form-group").last()),c=$("#J_tpl .team-user-item").clone(),c.find(".txt").text(a.name),c.data("data",a),c.insertBefore($("#J_userAdd"))},editTeamUserItem:function(a,b){var c=this,d=a.name;c.editArea.find(".user-item").eq(b).find(".control-label").text(d),$("#J_teamUsers .team-user-item").eq(b).find(".txt").text(d)},editUserItem:function(a,b){for(var c,d,e=$("#J_userPopup"),f=e.find(".form-control"),g=0,h=f.length;h>g;g++)c=$(f[g]),d=c.attr("name"),c.val(a[d]);e.find(".modal-title").text("编辑成员"),e.attr({"data-type":"edit","data-index":b}),e.modal("show")},renderTable:function(){var a=this,b=$("#J_result table"),c=$("#J_weekDays input:checked"),d=3,e=["姓名","座机","手机"],f=d+c.length,g="上海设计部",h=$("#J_teamType option:selected").text();h=g+h+"工作计划";var i=(new Date).getFullYear(),j=$(c[0]).data("date"),k=c[c.length-1];k=$(k).data("date");var l="("+i+"."+a.getFormatDate(j,3)+"~"+a.getFormatDate(k,3)+")";h+='<em class="data">'+l+"</em>",b.find("thead th").html(h).attr("colspan",f);var m=b.find(".title");m.html("");for(var n,o=null,p=0;f>p;p++)o=$("<td>"),p>0&&f-d+1>p?(n=p-1,o.text($(c[n]).parent().text())):(n=p>0?p-c.length:p,o.text(e[n])),m.append(o);var q,r;for(b.find(".table-user").remove(),p=0,len=a.teamData.length;p<len;p++)q=a.teamData[p],r=a.editArea.find(".user-item").eq(p).find(".schedule-item"),a.renderUserRow(q,r);$("#J_result").removeClass("hide")},renderUserRow:function(a,b){for(var c,d,e,f,g,h,i=$("#J_result table"),j=$("#J_weekDays input:checked"),k=3,l=["name","tel","mobile"],m=k+j.length,n=k+b.length,o=$("<tr>").attr("class","table-user"),p=0,q=0;n>q;q++)c=$("<td>"),q>0&&n-k+1>q?(d=q-1,e=$(b[d]),f=e.find(".content").val(),g=e.find(".num").val(),g=parseInt(g),g=isNaN(g)?1:g,h=e.find("select").val(),c.text(f).attr({colspan:g,"class":h+"-td schedule"}),p+=g):(d=q>0?q-b.length:q,f=a[l[d]],c.text(f).attr("class",l[d]),p++),o.append(c);m>p&&(c=$("<td>"),c.attr("colspan",m-p),c.insertBefore(o.find(".tel").last())),i.append(o)},selectTable:function(){var a=document.createRange(),b=$("#J_result table")[0];a.selectNode(b);var c=window.getSelection();c.removeAllRanges(),c.addRange(a)}};a.init()});